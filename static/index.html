<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>述格 (ScriptGrid)</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <style>
        /* 为焦点元素添加更明显的指示器，增强可访问性 */
        a:focus, button:focus, input:focus, select:focus {
            outline: 2px dashed #0d6efd; /* Bootstrap primary color */
            outline-offset: 2px;
        }
        /* 加载动画样式 */
        #loadingIndicator {
            display: none; /* 默认隐藏 */
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <h1 class="text-center mb-4">述格 (ScriptGrid)</h1>
                
                <!-- 信息提示区域 -->
                <div id="messageArea" class="alert" role="alert" style="display: none;" aria-live="polite"></div>

                <!-- 主表单 -->
                <form id="converterForm">
                    <div class="mb-3">
                        <label for="subtitleFile" class="form-label">选择字幕文件</label>
                        <input class="form-control" type="file" id="subtitleFile" accept=".ass,.srt,.xlsx"
                            aria-describedby="fileHelp">
                        <div id="fileHelp" class="form-text">支持 .ass, .srt, .xlsx 格式。</div>
                    </div>

                    <div class="mb-3">
                        <label for="conversionType" class="form-label">转换类型</label>
                        <select class="form-select" id="conversionType" aria-label="选择转换类型" disabled>
                            <option value="" selected>请先选择文件</option>
                        </select>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="convertBtn" disabled>开始转换</button>
                    </div>
                </form>

                <!-- 加载指示器 -->
                <div id="loadingIndicator" class="text-center mt-3" aria-live="polite">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">处理中...</span>
                    </div>
                    <p class="mt-2">处理中，请稍候...</p>
                </div>

            </div>
        </div>
    </div>

    <!-- 页尾 -->
    <footer class="mt-5 py-4 bg-light border-top">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6 text-center">
                    <p class="mb-2"><strong>述格 (ScriptGrid)</strong> 是一个专为口述影像创作者设计的便捷工具，支持口述稿在 Excel 格式和字幕格式之间的灵活转换。</p>
                    <p class="mb-0">如果您在使用过程中遇到任何问题或有改进建议，欢迎在 <a href="https://github.com/yunshenwuji/scriptgrid" target="_blank" rel="noopener noreferrer">GitHub 项目</a> 中提交 Issue，我们将积极响应并努力解决。</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
        crossorigin="anonymous"></script>

    <script>
        // 获取DOM元素
        const fileInput = document.getElementById('subtitleFile');
        const conversionTypeSelect = document.getElementById('conversionType');
        const convertButton = document.getElementById('convertBtn');
        const form = document.getElementById('converterForm');
        const messageArea = document.getElementById('messageArea');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // 定   义转换类型选项
        const conversionOptions = {
            '.ass': [
                { value: 'ass_to_srt', text: 'ASS 转 SRT (.ass -> .srt)' },
                { value: 'subtitle_to_excel', text: '字幕转表格 (.ass -> .xlsx)' }
            ],
            '.srt': [
                { value: 'subtitle_to_excel', text: '字幕转表格 (.srt -> .xlsx)' }
            ],
            '.xlsx': [
                { value: 'xlsx_to_srt', text: '表格转字幕 (.xlsx -> .srt)' }
            ]
        };

        // 文件选择事件监听器
        fileInput.addEventListener('change', function () {
            const file = this.files[0];
            if (file) {
                const fileName = file.name;
                const fileExtension = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();

                // 重置并更新转换类型下拉框
                conversionTypeSelect.innerHTML = '<option value="" selected>请选择转换类型</option>';
                conversionTypeSelect.disabled = false;

                const options = conversionOptions[fileExtension];
                if (options && options.length > 0) {
                    options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.text;
                        conversionTypeSelect.appendChild(opt);
                    });
                    convertButton.disabled = false; // 启用转换按钮
                    hideMessage(); // 清除可能存在的旧消息
                } else {
                    conversionTypeSelect.disabled = true;
                    convertButton.disabled = true;
                    showMessage('不支持的文件类型。', 'warning');
                }
            } else {
                // 如果没有选择文件，重置状态
                conversionTypeSelect.innerHTML = '<option value="" selected>请先选择文件</option>';
                conversionTypeSelect.disabled = true;
                convertButton.disabled = true;
                hideMessage();
            }
        });

        // 表单提交事件监听器
        form.addEventListener('submit', async function (e) {
            e.preventDefault(); // 阻止表单默认提交

            const file = fileInput.files[0];
            const conversionType = conversionTypeSelect.value;

            if (!file) {
                showMessage('请选择一个文件。', 'warning');
                return;
            }

            if (!conversionType) {
                showMessage('请选择转换类型。', 'warning');
                return;
            }

            // 准备FormData用于文件上传
            const formData = new FormData();
            formData.append('file', file);
            formData.append('conversion_type', conversionType);

            // 显示加载指示器，禁用表单控件
            showLoading(true);
            fileInput.disabled = true;
            conversionTypeSelect.disabled = true;
            convertButton.disabled = true;

            try {
                // 发送POST请求到后端API
                // 注意：'/api/convert' 是后端处理转换的API端点，需要与后端实现对应
                const response = await fetch('/api/convert', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    // 转换成功，处理文件下载
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    // 根据转换类型设置默认文件名后缀
                    let fileExt = '.xlsx';
                    if (conversionType === 'ass_to_srt' || conversionType === 'xlsx_to_srt') {
                        fileExt = '.srt';
                    }
                    link.download = file.name.substring(0, file.name.lastIndexOf('.')) + fileExt;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(downloadUrl); // 清理URL对象

                    showMessage('转换完成，文件已开始下载。', 'success');
                } else {
                    // 处理后端返回的错误
                    const errorText = await response.text();
                    console.error('转换失败:', response.status, errorText);
                    showMessage(`转换失败: ${errorText || '服务器错误'}`, 'danger');
                }
            } catch (error) {
                // 处理网络或其他异常
                console.error('请求失败:', error);
                showMessage(`请求失败: ${error.message}`, 'danger');
            } finally {
                // 隐藏加载指示器，恢复表单控件
                showLoading(false);
                fileInput.disabled = false;
                conversionTypeSelect.disabled = false;
                convertButton.disabled = false;
            }
        });

        // 显示消息的辅助函数
        function showMessage(message, type = 'info') {
            messageArea.textContent = message;
            messageArea.className = `alert alert-${type}`;
            messageArea.style.display = 'block';
            // 消息区域变化时，确保屏幕阅读器能读取到
            messageArea.setAttribute('aria-live', 'assertive');
            setTimeout(() => {
                 messageArea.setAttribute('aria-live', 'polite');
            }, 1000); // 1秒后降级为礼貌提醒
        }

        // 隐藏消息的辅助函数
        function hideMessage() {
            messageArea.style.display = 'none';
        }

        // 控制加载指示器显示的辅助函数
        function showLoading(isLoading) {
            if (isLoading) {
                loadingIndicator.style.display = 'block';
            } else {
                loadingIndicator.style.display = 'none';
            }
        }
    </script>
</body>
</html>